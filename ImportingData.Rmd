---
title: 'ECONOMICS: US Distributional National Accounts'
subtitle: "Getting the data"
author: "Kier O'Neil"
date: "12/4/2019"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(tidy = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

## Summary  
The economics work of Thomas Piketty (Paris School of Economics), Emmanuel Saez (UC Berkeley and NBER), and Gabriel Zucman (UC Berkeley and NBER) has been getting a lot of attention in the US recently, unfortunately their data is in Stata dta files and there is one for each year.  

This creates a barrier-to-entry for economists using R to re-create, explore, and critique their approach.  
This paper will give you code to import the micro-files for the years you are interested, rename variables to clarify their meanings, and a few other additions.   

I will also share resources to get you up to speed on Distributional National Accounts

## Resources  
Main reference site: <http://gabriel-zucman.eu/usdina/>  
Their [paper](http://gabriel-zucman.eu/files/PSZ2018QJE.pdf) in the Quarterly Journal of Economics  
[Video](https://www.youtube.com/watch?v=Zj6FReiRuRE) of Prof. Saez lecture regarding Distributional National Accounts  
Github repo for this project: <https://github.com/kieroneil/DistributionalNationalAccounts>  

##The code  
This is structured in a way that you can stop at different stages and use that data for future work.  
We assume that you have all of the dta files in a source directory and have copied the years that you are interested in to the `Dina_subset/` folder.  

> The Stages:  
> Stage 1 - Raw import of selected files into single dataframe with the year added  
> Stage 2 - Change grouping variable codes to descriptions for readability  
> Stage 3 - Rename columns for readability  
> Stage 4 - Transformations  & calculations  

###Stage 1  
####Get paths to subset of files  
```{r}
library(tidyverse)
library(fs)
library(haven)
library(openxlsx) # writing out excel workbooks

# Get the paths for your subset of files. From the `fs` package
# Each file has ~68760 rows and 144 variables
paths <- dir_ls("Dina_subset/") 
paths
```

####Import all of the Stata dta files into a single object  
Also, put the year from the filename into a new column  
```{r}
dina_df <- map_dfr(paths, ~ read_dta(.x), .id = "filename") %>%
  extract(filename, "year", "(\\d{4})")
```

###Stage 2 - Change grouping variable codes to descriptions  
```{r}
# Get the names of all the grouping variables
group_names <- names(dina_df[5:15])

# Change factor levels to decriptive labels 
# Assign to new vars and then drop originals and put at front
dina_df2 <- dina_df %>%
  mutate_at(group_names, as.character) %>%
  mutate(gender = if_else(female == "1", "Female", "Male", "Unknown"),
         agegroup_primary = recode(ageprim, "0" = "20-64", "20" = "20-44", 
                                   "45" = "45-64", "65" = "65 Plus"),
         agegroup_secondary = recode(agesec, "0" = "20-64", "20" = "20-44", 
                                     "45" = "45-64", "65" = "65 Plus"), 
         agegroup_imputed = recode(age, "0" = "20-64", "20" = "20-44", 
                                   "45" = "45-64", "65" = "65 Plus"), 
         labor_status_primary = if_else(oldexm == "1", "Retired", "Working", "Unknown"),
         labor_status_secondary = if_else(oldexf == "1", "Retired", "Working", "Unknown"),
         labor_status_imputed = if_else(oldexf == "1", "Retired", "Working", "Unknown"), 
         filing_status = if_else(married == "1", "Married", "Single", "Unknown"), 
         earner_status = if_else(second == "0", "Primary", "Secondary", "Unknown"), 
         num_kids = xkidspop, 
         filer_status = if_else(filer == "1", "Filer", "Not filer", "Unknown")
  ) %>%
  select(-group_names) %>%
  select(year, everything())

```

###Stage 3 - Rename columns  
I did not spend a lot of time here so there may be some missnamings.  I used the data dictionary as a reference and noticed along the way that there were some namings that could be done better as well as re-ordering.  

After going through the renaming excersize I understand that there is a naming convention to the original variable names so use your own discretion of whether to use the original or verbose names.  

I try to use consistent names so that you will be able to efficiently select column names with `contains()`.  

```{r}
# Get the names of new grouping variables
group_names <- names(dina_df2[135:145])

dina_df3 <- dina_df2 %>%
  select(id, group_names, everything()) %>%
  #select(-dweghttaxu, -dweghtold) %>%
  mutate_at(group_names, as.factor) %>%
  rename(
    tax_unit_id = id,
    population_weight = dweght,
    fiscal_income_excl_capgains = fiinc,
    fiscal_income_incl_capgains = fninc,
    personal_factor_income = fainc,
    personal_factor_labor_income = flinc,
    personal_factor_capital_income = fkinc,
    personal_pretax_income = ptinc,
    personal_pretax_labor_income = plinc,
    personal_pretax_capital_income = pkinc,
    extended_disposable_income = diinc,
    factor_national_income = princ,
    pretax_national_income = peinc,
    posttax_national_income = poinc,
    net_personal_wealth = hweal,
    fiscal_income_wages_pensions = fiwag,
    fiscal_income_business = fibus,
    fiscal_income_rents = firen,
    fiscal_income_interest = fiint,
    fiscal_income_dividends = fidiv,
    fiscal_income_capital_gains = fikgi,
    fiscal_income_nonfiler_default = fnps,
    taxable_pension_income = peninc,
    net_schedule_income = schcinc,
    net_s_corp_income = scorinc,
    net_partnership_income = partinc,
    net_rental_income = rentinc,
    net_estate_trust_income = estinc,
    net_royalty_income = rylinc,
    other_income_in_agi = othinc,
    compensation_of_employees = flemp,
    labor_share_net_mixed_income = flmil,
    labor_sales_excise_taxes = flprl,
    housing_asset_income = fkhou,
    equity_asset_income = fkequ,
    interest_income = fkfix,
    business_asset_income = fkbus,
    pension_insurance_asset_income = fkpen,
    interest_payments = fkdeb,
    social_contributions = plcon,
    labor_share_social_insurance_income = plbel,
    investment_income_paybable_pensions = pkpen,
    capital_share_social_insurance_income = pkbek,
    equity_assets = hwequ,
    currency_assets = hwfix,
    housing_assets = hwhou,
    business_assets = hwbus,
    pension_life_insurance_assets = hwpen,
    household_liabilities = hwdeb,
    taxable_wages_all_filers = flwag,
    supplements_to_taxable_wage = flsup,
    health_insurance_contributions = waghealth,
    pension_contributions = wagpen,
    main_house_asset_income = fkhoumain,
    rental_house_asset_income = fkhourent,
    mortgage_interest_payments = fkmor,
    non_mortgage_interest_payments = fknmo,
    capital_sales_excise_tax = fkprk,
    housing_property_tax = proprestax,
    business_property_tax = propbustax,
    rental_housing_wealth = rental,
    gross_rental_housing = rentalhome,
    mortgages_rental_housing = rentalmort,
    gross_main_housing_wealth = ownerhome,
    mortgages_main_housing = ownermort, 
    housing_wealth_net_debt = housing,
    partnership_wealth = partw, 
    sole_proprietor_wealth = soleprop, 
    s_corp_wealth = scorw,
    equity_wealth = equity, 
    taxable_bond_wealth = taxbond, 
    muni_bond_wealth = muni,
    currency_wealth = currency, 
    non_mortgage_debt = nonmort,
    net_personal_wealth_not_cap = hwealnokg,
    household_financial_assets = hwfin,
    household_non_financial_assets = hwnfa,
    pension_contributions_minus = plpco,
    di_ui_contributions = ploco,
    pension_benefits = plpbe,
    di_ui_benefits = plobe,
    social_insurance_income = plben,
    labor_share_pension_benefits = plpbl,
    personal_pretax_labor_pension_income = plnin,
    capital_share_pension_benefits = pkpbk, 
    personal_pretax_capital_pension_income = pknin,
    personal_pretax_pension_income = ptnin, 
    disposable_cash_income = dicsh,
    social_transfers_in_kind = inkindinc, 
    collective_consumption_expenditure_cce = colexp,
    cce_net_property_income_paid_by_govt = govin, 
    cce_net_income_non_profit = npinc, 
    primary_surplus_public_pension_system = prisupen,
    invest_income_payable_pensions = invpen,
    primary_surplus_private_pension_system = prisupenprivate,
    government_primary_surplus = prisupgov,
    cce_education = educ, 
    cce_education_2 = colexp2, 
    #poinc2 = poinc2,
    total_taxes_contributions_paid = tax,
    current_personal_taxes_income_wealth = ditax,
    federal_personal_income_taxes = ditaf,
    state_personal_income_taxes = ditas,
    sales_excise_taxes = salestax, 
    corporate_taxes = corptax,
    estate_taxes = estatetax,
    total_contributions_govt_social_insurance = govcontrib, 
    social_insurance_contributions = ssuicontrib,
    other_social_insurance_contributions = othercontrib,
    social_insurance_income_oldage = ssinc_oa,
    social_insurance_income_disability = ssinc_di,
    social_insurance_income_unemployment = uiinc,
    total_social_insurance_income = ben, 
    social_insurance_income_cash = dicab, 
    social_insurance_income_taxcredit = dicred,
    social_insurance_income_foodstamps = difoo,
    social_insurance_income_veterans = disup,
    social_insurance_income_workerscomp = divet,
    social_insurance_income_othercash = dicao,
    social_insurance_income_tanf = tanfinc,
    social_insurance_income_cashlocalstate = othben,
    social_insurance_income_medicare = medicare,
    social_insurance_income_medicaid = medicaid,
    social_insurance_income_inkind = otherkin,
    social_insurance_income_pell = pell,
    social_insurance_income_veteraninkind = vethealth
  ) 

```

####Stage 4 - Transformations  & calculations  
This is for everything else.  
For some reason the professors multiplied the population by 100,000.  I divide the 100,000 back out and now if you sum the population_weight for a given year it should equal the actual number of people in the US.  
```{r}
dina_df4 <- dina_df3 %>%
  mutate(
    year = factor(year),
    population_weight = population_weight / 100000,
    tax_rate = 1 - (posttax_national_income / pretax_national_income), 
    pretax_national_income_perperson = pretax_national_income / population_weight,
    posttax_national_income_perperson = posttax_national_income / population_weight
  )
```

####Save to another format  
At this point I'm ready to move on to exploratory data analysis so the data I want is assigned to a `_final` object and then exported.  My EDA code with also use `dina_final` as it's starting point.  

Be careful with the Excel save.  It takes a while and you could easily exceed the million-record max if you extract too many years.  
```{r eval=FALSE}
dina_final <- dina_df4

# Export to other formats
saveRDS(dina_final, "dina_data.RDS")
write.xlsx(dina_final, "dina_data.xlsx", asTable = TRUE) #Not recommended for larger datasets
```

##Conclusion  
In this paper I have given a method to bring economists that use R up to speed quickly with the US Distributional National Accounts datasets provided by Piketty, Saez, and Zucman.  

All of the data and code is on the [GitHub Repo](https://github.com/kieroneil/DistributionalNationalAccounts).

###END  
